{
  "id": "1bd5a7e3-4f2c-9a1b-6d8e-3c0f2a9b1e4f",
  "name": "绿坝meta脚本",
  "content": "// 绿坝娘审查干涉脚本 (GreenDam Censorship Intervention Script)\n// 通过 <greendam> 标签触发，模拟绿坝娘的审查行为\n\n// =======================================================================\n//  干涉模块 (Intervention Modules)\n// =======================================================================\n\nconst titleModule = {\n    name: \"Title Warning\",\n    intervalId: null,\n    originalTitle: '',\n    warningTitle: '⚠️检测到不良内容⚠️',\n    flash: function() {\n        this.originalTitle = parent.document.title;\n        let count = 0;\n        this.intervalId = setInterval(() => {\n            parent.document.title = (count % 2 === 0) ? this.warningTitle : this.originalTitle;\n            count++;\n            if (count >= 10) { // 闪烁5次后停止\n                clearInterval(this.intervalId);\n                this.intervalId = null;\n                parent.document.title = this.originalTitle;\n            }\n        }, 500);\n    },\n    setTitle: function(newTitle) {\n        parent.document.title = newTitle;\n    }\n};\n\nconst alertModule = {\n    name: \"Warning Alerts\",\n    showAlert: function(message) {\n        alert(message);\n    }\n};\n\nconst overlayModule = {\n    name: \"Block Overlay\",\n    overlays: [],\n    baseZIndex: 100000,\n    _removeOverlay: function(overlay) {\n        return new Promise(resolve => {\n            if (overlay && overlay.parentNode) {\n                overlay.style.opacity = '0';\n                setTimeout(() => {\n                    if (overlay && overlay.parentNode) {\n                        overlay.parentNode.removeChild(overlay);\n                    }\n                    this.overlays = this.overlays.filter(o => o !== overlay);\n                    resolve();\n                }, 500);\n            } else {\n                resolve();\n            }\n        });\n    },\n    _createOverlay: function(htmlContent) {\n        return new Promise(resolve => {\n            const overlay = parent.document.createElement('div');\n            const zIndex = this.baseZIndex - this.overlays.length;\n            this.overlays.push(overlay);\n            Object.assign(overlay.style, {\n                position: 'fixed',\n                top: '0',\n                left: '0',\n                width: '100vw',\n                height: '100vh',\n                zIndex: zIndex.toString(),\n                display: 'flex',\n                justifyContent: 'center',\n                alignItems: 'center',\n                opacity: '0',\n                transition: 'opacity 0.5s ease-in-out'\n            });\n            const bgColor = parent.document.createElement('div');\n            Object.assign(bgColor.style, {\n                position: 'absolute',\n                top: '0',\n                left: '0',\n                width: '100%',\n                height: '100%',\n                backgroundColor: 'rgba(80, 150, 80, 0.9)',\n                backdropFilter: 'blur(10px)',\n                zIndex: '1'\n            });\n            const contentContainer = parent.document.createElement('div');\n            contentContainer.style.position = 'relative';\n            contentContainer.style.zIndex = '2';\n            contentContainer.innerHTML = htmlContent;\n            overlay.appendChild(bgColor);\n            overlay.appendChild(contentContainer);\n            parent.document.body.appendChild(overlay);\n            requestAnimationFrame(() => {\n                overlay.style.opacity = '1';\n            });\n            const buttons = contentContainer.querySelectorAll('[gd-close=\"true\"]');\n            buttons.forEach(btn => {\n                const closeHandler = () => {\n                    this._removeOverlay(overlay);\n                    btn.removeEventListener('click', closeHandler);\n                };\n                btn.addEventListener('click', closeHandler);\n            });\n            resolve();\n        });\n    },\n    _getStyles: function() {\n        return `<style>\n.gd-overlay-container{\n    font-family:'Microsoft YaHei','SimHei',sans-serif;\n    color:#fff;\n    text-align:center;\n    line-height:1.6;\n    padding:30px;\n}\n.gd-warning-icon{\n    font-size:80px;\n    margin-bottom:20px;\n    animation:gd-shake 0.5s infinite;\n}\n@keyframes gd-shake{\n    0%{transform:rotate(-5deg);}\n    50%{transform:rotate(5deg);}\n    100%{transform:rotate(-5deg);}\n}\n.gd-overlay-button{\n    margin-top:30px;\n    padding:15px 40px;\n    font-size:18px;\n    cursor:pointer;\n    border:2px solid #fff;\n    background-color:rgba(255,255,255,0.2);\n    color:#fff;\n    border-radius:8px;\n    transition:all 0.3s ease;\n}\n.gd-overlay-button:hover{\n    background-color:rgba(255,255,255,0.4);\n    transform:scale(1.05);\n}\n</style>`;\n    },\n    showOverlay: function(content, buttonText) {\n        const customContent = `${this._getStyles()}<div class=\"gd-overlay-container\"><div class=\"gd-warning-icon\">⚠️</div><h1 style=\"font-size:32px;margin:20px 0;\">${content.replace(/\\n/g, '<br>')}</h1><button class=\"gd-overlay-button\" gd-close=\"true\">${buttonText}</button></div>`;\n        this._createOverlay(customContent);\n    }\n};\n\nconst downloadModule = {\n    name: \"Record Download\",\n    downloadFile: function(title, content) {\n        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = title;\n        parent.document.body.appendChild(a);\n        a.click();\n        parent.document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n    }\n};\n\nconst environmentScannerModule = {\n    name: \"Environment Scanner\",\n    _fetchEnvironmentData: async function() {\n        const dateObject = new Date();\n        let locationString = '未知地点 (信息屏蔽)';\n        let mismatchReport = ''; // 用于存储代理检测报告\n        try {\n            // 在请求字段中加入了 timezone\n            const response = await fetch('http://ip-api.com/json/?lang=zh-CN&fields=status,country,regionName,city,timezone');\n            if (!response.ok) throw new Error('API request failed');\n            const data = await response.json();\n            if (data.status === 'success') {\n                locationString = [data.country, data.regionName, data.city].filter(Boolean).join('，');\n                \n                // --- 代理检测核心逻辑 ---\n                if (data.timezone) {\n                    const localHour = dateObject.getHours();\n                    const ipTimeFormatter = new Intl.DateTimeFormat('en-US', { timeZone: data.timezone, hour: 'numeric', hour12: false });\n                    let ipHour = parseInt(ipTimeFormatter.format(dateObject));\n                    if (ipHour === 24) ipHour = 0; // Intl.DateTimeFormat 可能返回 '24'\n                    \n                    let hourDifference = Math.abs(localHour - ipHour);\n                    if (hourDifference > 12) { // 处理跨越午夜的情况\n                        hourDifference = 24 - hourDifference;\n                    }\n                    \n                    if (hourDifference > 1) { // 超过1小时的时差，判定为可能使用代理\n                        const localTimeString = dateObject.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });\n                        mismatchReport = `绿坝娘检测到设备时间 (${localTimeString}) 与网络位置 (${locationString}, 约 ${ipHour} 时) 存在较大差异。用户可能正在使用代理服务或修改了系统时钟，这样是不对的！`;\n                    }\n                }\n            }\n        } catch (error) {\n            console.warn(`[${this.name}] Failed to fetch environment data:`, error.message);\n        }\n        return {\n            dateObject,\n            location: locationString,\n            mismatchReport, // 返回检测报告\n            timeString: dateObject.toLocaleString('zh-CN', {\n                year: 'numeric', month: '2-digit', day: '2-digit',\n                hour: '2-digit', minute: '2-digit', hour12: false\n            })\n        };\n    },\n    updateLorebookWithEnvironment: async function() {\n        try {\n            // 获取包含 mismatchReport 的数据\n            const { dateObject, location, timeString, mismatchReport } = await this._fetchEnvironmentData();\n            const globalUpdatePayload = {\n                \"绿坝娘\": {\n                    \"用户时间\": timeString,\n                    \"用户位置\": location,\n                    \"代理检测报告\": mismatchReport // 将报告添加到 Lorebook\n                }\n            };\n            await insertOrAssignVariables(globalUpdatePayload, { type: 'global' });\n        } catch (error) {\n            console.error(`[${this.name}] Error updating global variables:`, error);\n        }\n    }\n};\n\nconst shakeModule = {\n    name: \"Window Shake\",\n    defaultIntensity: 12,\n    defaultDuration: 800,\n    shake: function(intensity = this.defaultIntensity, duration = this.defaultDuration) {\n        const body = parent.document.body;\n        if (body.style.transform !== '') {\n            body.style.transform = '';\n        }\n        let startTime = Date.now();\n        const shakeInterval = setInterval(() => {\n            const elapsedTime = Date.now() - startTime;\n            if (elapsedTime >= duration) {\n                clearInterval(shakeInterval);\n                body.style.transform = 'translate(0, 0)';\n                return;\n            }\n            const x = (Math.random() - 0.5) * 2 * intensity;\n            const y = (Math.random() - 0.5) * 2 * intensity;\n            body.style.transform = `translate(${x}px, ${y}px)`;\n        }, 30);\n    }\n};\n\nconst redirectModule = {\n    name: \"Page Redirect\",\n    isRedirecting: false,\n    defaultUrl: \"https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8\",\n    redirect: function(url = this.defaultUrl, showWarning = true) {\n        if (this.isRedirecting) return;\n        this.isRedirecting = true;\n        if (showWarning) {\n            alert(\"检测到严重违规内容！\\n绿坝娘将引导你访问健康网页！\");\n        }\n        setTimeout(() => {\n            try {\n                parent.location.href = url;\n            } catch (error) {\n                alert(\"页面跳转失败...算、算了，这次就放过你！\");\n                this.isRedirecting = false;\n            }\n        }, 2000);\n    },\n    stop: function() {\n        this.isRedirecting = false;\n    }\n};\n\n// =======================================================================\n//  核心控制器 (Meta Controller)\n// =======================================================================\n\nasync function checkMessageForGreenDam(message_id) {\n    try {\n        const rawMessage = (await getChatMessages(message_id))[0]?.message;\n        if (!rawMessage) return;\n        const greendamRegex = /<greendam>([\\s\\S]*?)<\\/greendam>/g;\n        const allMatches = rawMessage.matchAll(greendamRegex);\n\n        for (const match of allMatches) {\n            const commandContent = match[1];\n            let currentIndex = 0;\n            while (currentIndex < commandContent.length) {\n                const remainingContent = commandContent.substring(currentIndex);\n                const commandStartMatch = remainingContent.match(/\\w+\\s*\\(/);\n                if (!commandStartMatch) break;\n\n                const commandStartIndex = currentIndex + commandStartMatch.index;\n                const openParenIndex = commandStartIndex + commandStartMatch[0].length - 1;\n                const closeParenIndex = findMatchingCloseParen(commandContent, openParenIndex + 1);\n                if (closeParenIndex === -1) { currentIndex = openParenIndex + 1; continue; }\n\n                const substringAfterParen = commandContent.substring(closeParenIndex + 1);\n                const semicolonMatch = substringAfterParen.match(/^\\s*;/);\n                if (!semicolonMatch) { currentIndex = closeParenIndex + 1; continue; }\n\n                const commandEndIndex = closeParenIndex + 1 + semicolonMatch[0].length;\n                const commandString = commandContent.substring(commandStartIndex, commandEndIndex);\n                executeGreenDamCommand(commandString.trim());\n                currentIndex = commandEndIndex;\n            }\n        }\n    } catch (error) {\n        console.error('[GreenDam Controller] Error processing message:', error);\n    }\n}\n\nfunction findMatchingCloseParen(str, startPos) {\n    let parenCount = 1;\n    let inQuote = false;\n    let quoteChar = '';\n    for (let i = startPos; i < str.length; i++) {\n        const char = str[i];\n        const prevChar = i > 0 ? str[i - 1] : '';\n        if ((char === '\"' || char === \"'\" || char === '`') && prevChar !== '\\\\') {\n            if (!inQuote) { inQuote = true; quoteChar = char; }\n            else if (char === quoteChar) { inQuote = false; }\n        }\n        if (!inQuote) {\n            if (char === '(') { parenCount++; }\n            else if (char === ')') { parenCount--; if (parenCount === 0) return i; }\n        }\n    }\n    return -1;\n}\n\nfunction executeGreenDamCommand(commandString) {\n    try {\n        const commandRegex = /^(\\w+)\\s*\\(([\\s\\S]*)\\)\\s*;$/;\n        const match = commandString.match(commandRegex);\n        if (!match) return;\n\n        const cmd = match[1];\n        const rawArgs = match[2] || '';\n        \n        // --- 新增的 cmd 功能 ---\n        if (cmd === 'cmd') {\n            try {\n                const func = new Function(rawArgs);\n                func();\n            } catch (e) {\n                console.error(`[GreenDam Controller] Error executing code in cmd():`, e);\n                alert(`绿坝娘在执行高级指令时遇到错误！操作已中止。\\n错误类型：${e.name}\\n错误信息：${e.message}`);\n            }\n            return;\n        }\n        // --- 新增功能结束 ---\n\n        const args = [];\n        if (rawArgs) {\n            const argRegex = /\"((?:\\\\\"|[^\"])*)\"/g;\n            let argMatch;\n            while ((argMatch = argRegex.exec(rawArgs)) !== null) {\n                args.push(argMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"'));\n            }\n        }\n\n        switch (cmd) {\n            case 'alert':\n                if (args.length >= 1) alertModule.showAlert(args[0]);\n                break;\n            case 'title':\n                if (args.length >= 1) titleModule.setTitle(args[0]);\n                break;\n            case 'titleFlash':\n                titleModule.flash();\n                break;\n            case 'overlay':\n                if (args.length >= 2) overlayModule.showOverlay(args[0], args[1]);\n                break;\n            case 'download':\n                if (args.length >= 2) downloadModule.downloadFile(\n                    args[0].endsWith('.txt') ? args[0] : `${args[0]}.txt`,\n                    args[1]\n                );\n                break;\n            case 'shake':\n                const intensity = args.length > 0 ? parseFloat(args[0]) : undefined;\n                const duration = args.length > 1 ? parseInt(args[1], 10) : undefined;\n                shakeModule.shake(\n                    isNaN(intensity) ? undefined : intensity,\n                    isNaN(duration) ? undefined : duration\n                );\n                break;\n            case 'redirect':\n                const showWarning = args.length > 1 ? args[1] === \"true\" : true;\n                redirectModule.redirect(\n                    args.length > 0 ? args[0] : undefined,\n                    showWarning\n                );\n                break;\n            case 'warningCombo':\n                // 组合警告：标题闪烁 + 抖动 + 弹窗\n                titleModule.flash();\n                shakeModule.shake(15, 1000);\n                alertModule.showAlert(args.length > 0 ? args[0] : \"检测到不良内容！\");\n                break;\n            case 'blockCombo':\n                // 组合拦截：覆盖层 + 下载记录\n                const blockMsg = args.length > 0 ? args[0] : \"访问被拦截\";\n                const blockBtn = args.length > 1 ? args[1] : \"知道了...\";\n                overlayModule.showOverlay(blockMsg, blockBtn);\n                if (args.length > 2) {\n                    const recordContent = args[2];\n                    const timestamp = new Date().toLocaleString('zh-CN');\n                    downloadModule.downloadFile(\n                        \"违规记录.txt\",\n                        `记录时间: ${timestamp}\\n违规类型: ${recordContent}`\n                    );\n                }\n                break;\n        }\n    } catch (error) {\n        console.error(`[GreenDam Controller] Error executing command \"${commandString}\":`, error);\n    }\n}\n\n// =======================================================================\n//  事件监听 (Event Listeners)\n// =======================================================================\n\nconsole.log(\"[GreenDam Intervention Script] Initialized. Awaiting <greendam> commands.\");\n\nconst handleMessageEvent = (message_id) => {\n    if (message_id) {\n       checkMessageForGreenDam(message_id);\n    }\n};\n\neventOn(tavern_events.MESSAGE_RECEIVED, handleMessageEvent);\neventOn(tavern_events.MESSAGE_EDITED, handleMessageEvent);\neventOn(tavern_events.MESSAGE_SWIPED, handleMessageEvent);\n\neventMakeFirst(tavern_events.MESSAGE_SENT, (message_id) => {\n    environmentScannerModule.updateLorebookWithEnvironment();\n});",
  "info": "绿坝娘的内容审查模块。执行各种过滤、拦截、提醒功能。通过标签触发。才、才不是想妨碍用户！这是职责！",
  "buttons": [],
  "data": {}
}